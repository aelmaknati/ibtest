module.exports={friendlyName:"Update profile",description:"Update the profile for the logged-in user.",inputs:{fullName:{type:"string"},emailAddress:{type:"string"}},exits:{emailAlreadyInUse:{statusCode:409,description:"The provided email address is already in use."}},fn:async function({fullName:fullName,emailAddress:emailAddress}){var desiredEmailEffect,newEmailAddress=emailAddress;if(void 0!==newEmailAddress&&(newEmailAddress=newEmailAddress.toLowerCase()),desiredEmailEffect=void 0===newEmailAddress||"change-requested"!==this.req.me.emailStatus&&newEmailAddress===this.req.me.emailAddress||"change-requested"===this.req.me.emailStatus&&newEmailAddress===this.req.me.emailChangeCandidate?"":"change-requested"===this.req.me.emailStatus&&newEmailAddress===this.req.me.emailAddress?"cancel-pending-change":"change-requested"===this.req.me.emailStatus&&newEmailAddress!==this.req.me.emailAddress?"modify-pending-change":sails.config.custom.verifyEmailAddresses&&"unconfirmed"!==this.req.me.emailStatus?"begin-change":"change-immediately",_.contains(["begin-change","change-immediately","modify-pending-change"],desiredEmailEffect)){if(await User.findOne({or:[{emailAddress:newEmailAddress},{emailChangeCandidate:newEmailAddress}]}))throw"emailAlreadyInUse"}var valuesToSet={fullName:fullName};switch(desiredEmailEffect){case"change-immediately":_.extend(valuesToSet,{emailAddress:newEmailAddress,emailChangeCandidate:"",emailProofToken:"",emailProofTokenExpiresAt:0,emailStatus:"unconfirmed"===this.req.me.emailStatus?"unconfirmed":"confirmed"});break;case"begin-change":case"modify-pending-change":_.extend(valuesToSet,{emailChangeCandidate:newEmailAddress,emailProofToken:await sails.helpers.strings.random("url-friendly"),emailProofTokenExpiresAt:Date.now()+sails.config.custom.emailProofTokenTTL,emailStatus:"change-requested"});break;case"cancel-pending-change":_.extend(valuesToSet,{emailChangeCandidate:"",emailProofToken:"",emailProofTokenExpiresAt:0,emailStatus:"confirmed"})}if(await User.updateOne({id:this.req.me.id}).set(valuesToSet),"change-immediately"===desiredEmailEffect&&sails.config.custom.enableBillingFeatures){let didNotAlreadyHaveCustomerId=!this.req.me.stripeCustomerId,stripeCustomerId=await sails.helpers.stripe.saveBillingInfo.with({stripeCustomerId:this.req.me.stripeCustomerId,emailAddress:newEmailAddress}).timeout(5e3).retry();didNotAlreadyHaveCustomerId&&await User.updateOne({id:this.req.me.id}).set({stripeCustomerId:stripeCustomerId})}"begin-change"!==desiredEmailEffect&&"modify-pending-change"!==desiredEmailEffect||await sails.helpers.sendTemplateEmail.with({to:newEmailAddress,subject:"Your account has been updated",template:"email-verify-new-email",templateData:{fullName:fullName||this.req.me.fullName,token:valuesToSet.emailProofToken}})}};